\startmodule    [filter]

\unprotect

\startinterface all
  \setinterfaceconstant {filter}           {filter}
  \setinterfaceconstant {filtercommand}    {filtercommand}
  \setinterfaceconstant {output}           {output} 
  \setinterfaceconstant {read}             {read} 
  \setinterfaceconstant {readcommand}      {readcommand} 
\stopinterface

\def\??externalfilter??{externalfilter}


\def\namedexternalfilterparameter#1#2%
  {\executeifdefined{\??externalfilter??::#1::#2}
     {\executeifdefined{\??externalfilter??::#2}{}}}

\def\setupexternalfilters
  {\dodoubleargument\dosetupexternalfilters}
  
\def\dosetupexternalfilters[#1][#2]%
  {\ifsecondargument
     \getparameters[\??externalfilter??::#1::][#2]%
   \else
      \getparameters[\??externalfilter??::][#1]%
   \fi}


\def\defineexternalfilter
  {\dodoubleargument\dodefineexternalfilter}

\def\dodefineexternalfilter[#1][#2]%
  {\setupexternalfilters[#1][#2]%
   \doifelse{\namedexternalfilterparameter{#1}\c!continue}\v!yes
      {\expandafter\newcounter\csname\??externalfilter??-#1-counter\endcsname%
       \setvalue{\e!start#1}%
          {\dostartbuffer[\??externalfilter??-#1-\getvalue{\??externalfilter??-#1-counter}]
                         [\e!start#1][\e!stop#1]}}%
      {\setvalue{\e!start#1}%
          {\dostartbuffer[\??externalfilter??-#1]
                         [\e!start#1][\e!stop#1]}}%
   \setvalue{\e!stop#1}{\doprocessexternalfilter{#1}}%
   \setvalue{process#1file}{\dodoubleargument\doprocessexternalfile[#1]}%
   %TODO: Inline.
   %\setvalue{#1}##1{\save ##1 to file}
   }

\def\doprocessexternalfilter#1%
  {% Initializations
   \edef\currentexternalfilter   {#1}%
   \doifelse{\namedexternalfilterparameter{#1}\c!continue}\v!yes
      {\edef\externalfiltertmpfile{\??externalfilter??-#1-\getvalue{\??externalfilter??-#1-counter}}}
      {\edef\externalfiltertmpfile{\??externalfilter??-#1}}%
   % By defualt, buffers are in memory in MkIV
   \doifmode{*mkiv}{\savebuffer[\externalfiltertmpfile]}%
   % The following  macros are useful for filter= and filtercommand= options
   % The basename of the external file 
   \edef\externalfilterbasefile  {\jobname-\externalfiltertmpfile}%
   % The name of the buffer to which data is written
   \edef\externalfilterinputfile {\externalfilterbasefile.tmp}%
   % The name of the file to which the output is written
   \edef\externalfilteroutputfile{\namedexternalfilterparameter{#1}\c!output}%
   % Run external command
   \doexecuteexternalfilter
   % Finalization
   \doif{\namedexternalfilterparameter{#1}\c!continue}\v!yes
        {\expandafter\increment\csname\??externalfilter??-#1-counter\endcsname}%
   }

\def\doexecuteexternalfilter%
  {\doifelse{\namedexternalfilterparameter\currentexternalfilter\c!continue}\v!yes
   {\doifmode{*first}
     {\executesystemcommand
      {mtxrun --ifchanged=\externalfilterinputfile\space 
          bin:\namedexternalfilterparameter\currentexternalfilter\c!filtercommand}}}%
   {\executesystemcommand
      {\namedexternalfilterparameter\currentexternalfilter\c!filtercommand}}%
   % Process output
   \doif{\namedexternalfilterparameter\currentexternalfilter\c!read}\v!yes
      {\doiffileelse{\externalfilteroutputfile}
          {\doreadprocessedfile}
          {TODO: File \externalfilteroutputfile\ not found! Check your definition}}%
  }

\def\doreadprocessedfile%
  {\bgroup
   \doprocesslocalsetups{\namedexternalfilterparameter\currentexternalfilter\c!setups}%
   \namedexternalfilterparameter\currentexternalfilter\c!before
   \namedexternalfilterparameter\currentexternalfilter\c!readcommand\externalfilteroutputfile
   \namedexternalfilterparameter\currentexternalfilter\c!after
   \egroup}

\def\doprocessexternalfile[#1][#2]%
  {\edef\currentexternalfilter    {#1}%
   \edef\externalfilterinputfile  {#2}%
   \splitfiletype {#2}%
   %BEWARE. \edef doesn not work
   \def\externalfilterbasefile   {\splitoffname}
   \def\externalfilteroutputfile{\namedexternalfilterparameter{#1}\c!output}%
   \doexecuteexternalfilter}
   

\setupexternalfilters
  [
   \c!before=,
   \c!after=,
   \c!setups=,
   \c!continue=\v!no,
   \c!read=\v!yes,
   \c!readcommand=\input,
   \c!output=\externalfilterbasefile.tex,
   \c!filter=,
   \c!filtercommand={\namedexternalfilterparameter\currentexternalfilter\c!filter\space \externalfilterinputfile},
 ]
   
% For tracing
\def\showexternalfilterstate
  {\starttable[|l|l|]
  \NC currentexternalfilter     \NC \currentexternalfilter      \NC \AR
  \NC externalfilterinputfile   \NC \externalfilterinputfile    \NC \AR
  \NC externalfilteroutputfile  \NC \externalfilteroutputfile   \NC \AR
  \NC externalfilterbasefile    \NC \externalfilterbasefile     \NC \AR
  \stoptable}
   
\protect
\stopmodule

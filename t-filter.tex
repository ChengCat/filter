\unprotect

\startinterface all
  \setinterfaceconstant {filter}    {filter}
  \setinterfaceconstant {output}    {output} 
\stopinterface

\def\??externalfilter??{externalfilter}


\def\namedexternalfilterparameter#1#2%
  {\executeifdefined{\??externalfilter??::#1::#2}
     {\executeifdefined{\??externalfilter??::#2}{}}}

\def\setupexternalfilters
  {\dodoubleargument\dosetupexternalfilters}
  
\def\dosetupexternalfilters[#1][#2]%
  {\ifsecondargument
     \getparameters[\??externalfilter??::#1::][#2]%
   \else
      \getparameters[\??externalfilter??::][#1]%
   \fi}


\def\defineexternalfilter
  {\dodoubleargument\dodefineexternalfilter}

\def\dodefineexternalfilter[#1][#2]%
  {\setupexternalfilters[#1][#2]%
   \setvalue{\e!start#1}%
      {\dostartbuffer[\??externalfilter??-#1][\e!start#1][\e!stop#1]}%
   \doifelse{\namedexternalfilterparameter{#1}{auto}}\v!yes
    {\setvalue{\e!stop#1}{\doprocessexternalfilter{#1}}}
    {\letvalue{\e!stop#1}=\relax}
   \setvalue{readprocessedfile#1}{\doreadprocessedfile{#1}}
   % stop#1 and readprocessedfile#1 may be overwritten by child modules.
   %TODO: Inline.
   %\setvalue{#1}##1{\save ##1 to file}
   }

\def\doprocessexternalfilter#1%
  {\doifmode{*mkiv}{\savebuffer[\??externalfilter??-#1]}%
   \edef\externalfilterinputfile {\jobname-\??externalfilter??-#1}%
   \edef\externalfilteroutputfile{\namedexternalfilterparameter{#1}\c!output}%
   \executesystemcommand
      {\namedexternalfilterparameter{#1}\c!filter\space
        \externalfilterinputfile.tmp}%
   \doiffileelse{\externalfilteroutputfile}
      {\getvalue{readprocessedfile#1}}
      {TODO: Show an error}}

\def\doreadprocessedfile#1%
  {\setups{externalfilter:#1}%
   \namedexternalfilterparameter{#1}\c!before
   \input \externalfilteroutputfile
   \namedexternalfilterparameter{#1}\c!after}

\setupexternalfilters
  [\c!auto=\v!yes,
   \c!output=\externalfilterinputfile.tex,
   \c!filter=]
   
\protect

\startmodule    [filter]

\unprotect

\startmode[\s!mkiv]
  \ctxloadluafile{t-filter}
\stopmode


\startinterface all
  \setinterfaceconstant {filter}           {filter}
  \setinterfaceconstant {filtercommand}    {filtercommand}
  \setinterfaceconstant {output}           {output} 
  \setinterfaceconstant {read}             {read} 
  \setinterfaceconstant {readcommand}      {readcommand} 

  \setinterfacevariable {httpget}          {httpget}
  \setinterfacevariable {httppost}         {httppost}
\stopinterface

\def\??externalfilter??{externalfilter}

\def\currentexternalfilter{}

\def\externalfilterparameter   #1{\csname\docheckparentparameter{\??externalfilter??\currentexternalfilter}{#1}\endcsname}

\def\docheckparentparameter  #1#2{\ifcsname#1#2\endcsname#1#2\else\expandafter\redocheckparentparameter\csname#1\s!parent\endcsname{#2}\fi}
\def\redocheckparentparameter#1#2{\ifx#1\relax\s!empty\else\docheckparentparameter{#1}{#2}\fi}

\def\setupexternalfilters
  {\dodoubleargument\dosetupexternalfilters}
  
\def\dosetupexternalfilters[#1][#2]%
  {\ifsecondargument
     \getparameters[\??externalfilter??#1][#2]%
   \else
     \getparameters[\??externalfilter??][#1]%
   \fi}


\def\defineexternalfilter
  {\dodoubleargument\dodefineexternalfilter}

\def\dodefineexternalfilter[#1][#2]%
  {\edef\currentexternalfilter{#1}%
  \getparameters[\??externalfilter??#1][\s!parent=\??externalfilter??,#2]%
   \doif{\externalfilterparameter\c!continue}\v!yes
      {\expandafter\newcounter\csname\??externalfilter??-#1-counter\endcsname}%
   \setvalue{\e!start#1}{\bgroup\obeylines\dodoubleargument\dostartexternalfilter[#1]}%
   \setvalue{\e!stop#1}{\doprocessexternalfilter}%
   \setvalue{process#1file}{\dodoubleargument\doprocessexternalfile[#1]}%
   %TODO: Inline.
   %\setvalue{#1}##1{\save ##1 to file}
   }


\chardef\externalfilter!!alternative\zerocount    %0 = os, 1 = httpget, 2 = httppost

\def\dostartexternalfilter[#1][#2]% filter options
  {% Initializations
   \egroup %\bgroup in \start#1
   \begingroup % to keep assignments local
   \edef\currentexternalfilter   {#1}%
   \getparameters[\??externalfilter??#1][\c!name=,#2]%
   \processaction[\externalfilterparameter\c!alternative]
                 [\v!httpget  => \chardef\externalfilter!!alternative\plusone ,
                  \v!httppost => \chardef\externalfilter!!alternative\plustwp ,
                  \v!default  => \chardef\externalfilter!!alternative\zerocount ,
                  \v!unknwon  => \chardef\externalfilter!!alternative\zerocount ]%
   % Set the name of temp file for os filter
   \doifelse{\externalfilterparameter\c!continue}\v!yes
       {\edef\externalfiltertmpfile{\??externalfilter??-#1-\getvalue{\??externalfilter??-#1-counter}}}
       {\edef\externalfiltertmpfile{\??externalfilter??-#1}}
   \doifsomething{\externalfilterparameter\c!name}
       {\edef\externalfiltertmpfile{\externalfilterparameter\c!name}}
   % The following  macros are useful for filter= and filtercommand= options
   % The basename of the external file 
   \edef\externalfilterbasefile  {\jobname-\externalfiltertmpfile}%
   % The name of the buffer to which data is written
   \edef\externalfilterinputfile {\externalfilterbasefile.tmp}%
   % The name of the file to which the output is written
   \edef\externalfilteroutputfile{\externalfilterparameter\c!output}%
   % Capture the contents of the buffer
   \dostartbuffer[\externalfiltertmpfile][\e!start#1][\e!stop#1]}

\def\doprocessexternalfilter%
  {\ifcase\externalfilter!!alternative % os 
     % By defualt, buffers are in memory in MkIV
     \doifmode\s!mkiv{\savebuffer[\externalfiltertmpfile]}%
     % Run external command
     \doexecuteexternalfilter
   \or % httpget
     \doexecutehttpgetfilter
   \or % httppost
     \doexecutehttpostfilter
   \fi
   % Process output
   \doif{\externalfilterparameter\c!read}\v!yes
      {\doiffileelse{\externalfilteroutputfile}
          {\doreadprocessedfile}
          {{\tttf TODO: File \externalfilteroutputfile\ not found! Check your definition}}}%
   \endgroup 
   % Finalization
   \ifnum\externalfilter!!alternative=\zerocount
     \doif{\externalfilterparameter\c!continue}\v!yes
          {\expandafter\increment\csname\??externalfilter??-\currentexternalfilter-counter\endcsname}%
   \fi
   }

\def\doexecuteexternalfilter
  {\doifelse{\externalfilterparameter\c!continue}\v!yes
   {\doifmode{*first}
     {\executesystemcommand
      {mtxrun --ifchanged=\externalfilterinputfile\space 
          bin:\externalfilterparameter\c!filtercommand}}}
   {\executesystemcommand
      {\externalfilterparameter\c!filtercommand}}}

\def\doexecutehttpgetfilter
  {\doifmodeelse{\s!mkiv}
    {\edef\externalfilteroutputfile{\ctxlua{thirddata.externalfilter.httpget
      (\!!bs\externalfilterparameter\c!filter\!!es  ,
       \!!bs\externalfiltertmpfile\!!es             ,
       % \externalfilterparameter\c!extras            , % should be a table
       \!!bs\externalfilterparameter\c!separator\!!es)}}}
    {{\tttf TODO: httpget does not work in MkII}}}

\def\doexecutehttppostfilter
    {{\tttf TODO: httppost is not yet implemented}}
  

\def\doreadprocessedfile%
  {\bgroup
   \externalfilterparameter\c!before
   \processcommacommand[\externalfilterparameter\c!setups]\directsetup
   \externalfilterparameter\c!readcommand\externalfilteroutputfile
   \externalfilterparameter\c!after
   \egroup}

\def\doprocessexternalfile[#1][#2]%
  {\edef\currentexternalfilter    {#1}%
   \edef\externalfilterinputfile  {#2}%
   \splitfiletype {#2}%
   %BEWARE. \edef doesn not work
   \def\externalfilterbasefile   {\splitoffname}
   \def\externalfilteroutputfile{\externalfilterparameter\c!output}%
   \doexecuteexternalfilter}
   

\setupexternalfilters
  [
   \c!before=,
   \c!after=,
   \c!setups=,
   \c!continue=\v!no,
   \c!read=\v!yes,
   \c!readcommand=\ReadFile,
   \c!output=\externalfilterbasefile.tex,
   \c!filter=,
   \c!alternative=\v!default,
   \c!filtercommand={\externalfilterparameter\c!filter\space \externalfilterinputfile},
   % \c!extras={ thirddata.externalfilter.urireplace },
   \c!separator=,
 ]
   
% For tracing
\def\showexternalfilterstate
  {\starttable[|l|l|]
  \NC currentexternalfilter     \NC \currentexternalfilter      \NC \AR
  \NC externalfilterinputfile   \NC \externalfilterinputfile    \NC \AR
  \NC externalfilteroutputfile  \NC \externalfilteroutputfile   \NC \AR
  \NC externalfilterbasefile    \NC \externalfilterbasefile     \NC \AR
  \stoptable}
   
\protect
\stopmodule

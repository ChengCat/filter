\usemodule[filter]

\traceexternalfilters

\unprotect
\def\gnuplotcommandno
  {gnuplot 
     -e "set term pdf
             size \externalfilterparameter\c!width,\externalfilterparameter\c!height ; 
          set output '\externalfilteroutputfile'"
      \jobname-gnuplotinclusions.tmp \externalfilterinutfile}

\def\gnuplotcommandyes
  {--noquotes gnuplot 
     '-e "set term pdf
             size \externalfilterparameter\c!width,\externalfilterparameter\c!height ; 
          set output \letterbackslash"\externalfilteroutputfile\letterbackslash""
      \jobname-gnuplotinclusions.tmp \externalfilterinputfile'}

\def\startgnuplotinclusions
  {\dostartbuffer[gnuplotinclusions][startgnuplotinclusions][stopgnuplotinclusions]}

\def\stopgnuplotinclusions
  {\doifmode\s!mkiv{\savebuffer[gnuplotinclusions][\jobname-gnuplotinclusions.tmp]}}

\defineexternalfilter
  [gnuplot]
  [\c!output=\externalfilterbasefile.pdf,
   \c!filtercommand=\getvalue{gnuplotcommand\externalfilterparameter\c!continue},
   \c!readcommand=\gnuplotreadcommand,
   \c!width=5in,
   \c!height=3in,
   \c!continue=\v!yes,
  ]

\def\gnuplotreadcommand#1%
  {\externalfigure[#1]} 

\protect

\starttext
\startgnuplotinclusions
  set title "Made with ConTeXt"
\stopgnuplotinclusions

\startgnuplot
  plot sin(x)
\stopgnuplot

\startgnuplot[width=3in]
  plot cos(x)
\stopgnuplot
\stoptext

   
